---
title: "Data Cleaning and Processing in R: Part 1"
date: "May 13, 2024"
css:
  - |
    .smaller h1 {
      font-size: 0.5em; /* Adjust the font size as needed */
    }
output:
  quarto::quarto_presentation:
    format: revealjs
    theme: 
      logo: images/primary_full-color.png
      theme: theme/slides.scss # Choose a theme for your presentation (e.g., simple, serif, solarized, etc.)
    incremental: true # Whether to display content incrementally (one step at a time)
    self_contained: true # Whether to create a standalone HTML file
    highlight_style: "github" # Syntax highlighting style (e.g., github, monokai, etc.)
    revealjs:
      controls: true # Display navigation controls (e.g., arrows, slide number, etc.)
      progress: true # Display a progress bar
      slideNumber: true # Display slide numbers
      center: true # Center the content on each slide
      chalkboard: true # Enable chalkboard mode for reveal.js
---

```{r}
#| output: false


library(tidyverse)
library(countdown)
library(tigris)
library(sf)
library(scales)
library(edbuildr)
library(viridis)

bw_primary <- c("#6D1E4A", # 1 plum
                "#007786", # 2 teal
                "#0D525A", # 3 dark green
                "#212B46", # 4 navy
                "#5A6675", # 5 grey
                "#F0DEC1") # 6 cream

bw_secondary <- c("#FFC762", # 1 yellow
                  "#FFB653", # 2 orange
                  "#BEC6CE", # 3 light grey
                  "#2E1A4A", # 4 deep purple
                  "#7EA2D1", # 5 soft blue
                  "#CAD3FB", # 6 lavender
                  "#9CD4EA", # 7 sky
                  "#FFA497") # 8 peach


```

## Agenda

-   Homework review
-   Principles of tidy data
-   Techniques to clean messy data
-   Joining data sets
-   Homework and next class

# Homework Review

## Solving a common problem with the homework

TKTK

# Principles of tidy data

## Cleaning your data: One of the most important and under-appreciated stages of good data analysis

-   Most data rarely come to us in a format that is plug-and-play ready for analysis.

-   High-quality data analysis must start with gathering and cleaning relevant data.

-   This starts with ensuring that each data frame of raw data you read into R goes through a process of becoming "tidy" --- once you have tidy data, merging and visualizing data becomes much easier.

-   The process of tidying your data is also helpful for identifying anomalies or outliers in your raw data files.

> **"Tidy data sets are all alike, but every messy data set is messy in its own way."** - Hadley Wickham

## The principles of "tidy data" provide a helpful vision of what good, clean data should look like

Tidy data follows three rules:

1.  Each column is a variable
2.  Each row is an observation
3.  Each cell is a value

![Source: R for Data Science](https://d33wubrfki0l68.cloudfront.net/6f1ddb544fc5c69a2478e444ab8112fb0eea23f8/08547/images/r4ds/tidy-1.png){fig-align="center" width="3520"}

## Building tidy datasets will bring consistency to your data across scripts/projects

Tidy datasets also make it easier to work with functions in the `tidyverse`, which is built to work will with "tidy" data

![](https://bookdown.org/michela_cameletti/rcodingfordatascience/images/4_tidyverse-packages.png){fig-align="center"}

## It takes some work to make data tidy, including the use of functions to reshape your data {.smaller}

Data sets can violate the principles of tidy data in several ways. The most common way is for a variable to be embedded across columns. For example, multiple columns can represent data from different years. In this case, a variable (year) is actually represented by column names instead of being captured in its own "year" column.

**Solution:** If your data includes a variable that is embedded across several column names, use the **pivot_longer()** function

![Source: R for Data Science](https://epirhandbook.com/en/images/pivoting/pivot_longer_new.png)

## Live coding example: Using `pivot_longer()` function {.smaller}

Key arguments of the `pivot_longer()` function:

-   `cols`: The names of the columns to pivot using tidy-select
-   `names_to`: The name for the new character column
-   `values_to`: The name for the new values column

```{r}

# idea_clean.R
# lasted updated 2024-04-26 by Krista Kaput

# load -----

library(tidyverse)
library(readxl)
library(dplyr)

section_611_raw <- read_excel("data/raw/IDEA Part B FY 2011 to FY 2022 .xlsx", 
                                 sheet = "Grants to States")

# clean the special education data -----

section_611_longer <- section_611_raw |>
  # Makes all the letters in a column lowercase
  rename_with(tolower) |>
  select(state, fy2016, fy2017, fy2018, fy2019, fy2020, fy2021, fy2022) |>
  pivot_longer(cols = starts_with("fy"), # The columns start with "fy"
               names_to = "fiscal_year", # the names of the columns will become a value in the "fiscal_year" column
               values_to = "idea_funding") |> # The values in the "fy" columns will be in the new column "idea_funding"
  # Use the gsub to remove the "fy" from the fiscal years so that the values are just the year
  mutate(fiscal_year = as.numeric(gsub("^fy", "", fiscal_year))) |>
  mutate(idea_category = "Part B, Grants to States")


```

## It takes a bit of work to make data tidy, including the use of functions to reshape your data, cont. {.smaller}

A single observation may be spread across multiple rows: This can happen when one column includes multiple variable types within it. And example would be if a dataframe had a "data_type" column that included entries like "n_tested" and "pct_prof".

**Solution:** If your data includes data from a single observation spread across multiple rows, use the **pivot_wider()** function

![Source: R for Data Science](https://bcheggeseth.github.io/112_fall_2022/images/pivot_wider.png)

## Live coding example: Using `pivot_wider()` function

Breaking down the code:

-   `names_from`: The column with values that include multiple variables; will be pivoted into column names.
-   `values_from`: The column with values will be used as cell values after pivoting.

```{r}

# Use pivot_wider with the 2023 graduation rate data 

mn_graduation_fy23_wider <- mn_graduation_fy23_raw |>
  # Makes all the letters in a column lowercase
  rename_with(tolower) |>
  # rename the columns so there isn't a space in-between the words
  rename(district = "district name",
         dist_id = "district number",
         dist_type = "district type",
         group_category = "group category",
         student_group = "student group",
         ending_status = "ending status",
         four_yr_grad_pct = "four year percent") |>
  # Select the columns we want to include in our dataframe for the pivot_wider
  select(district, dist_id, dist_type, group_category, student_group, ending_status, four_yr_grad_pct) |>
  # filter so that we are only looking at students who graduated in four years
  filter(ending_status == "Graduate") |>
  # filter the student demographics because we only want to look at race/ethnicity data
  filter(group_category == "Race/Ethnicity") |>
  # Pivot_wider! 
  pivot_wider(names_from = "student_group", # The names of the columns are from the student group column values
              values_from = "four_yr_grad_pct") 


````

# Techniques to clean messy data

## Cleaning data can be challenging, but it's easier if you take a systematic approach to every raw data file {.smaller}

+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Step               | Goal                                                                                                                                                                   |
+====================+========================================================================================================================================================================+
| Data import        | Ensure your import function is set up to read the data properly                                                                                                        |
+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Column names       | Reformat or manually create column names that are:                                                                                                                     |
|                    |                                                                                                                                                                        |
|                    | -   lowercase                                                                                                                                                          |
|                    |                                                                                                                                                                        |
|                    | -   use underscores instead of spaces                                                                                                                                  |
|                    |                                                                                                                                                                        |
|                    | -   do not begin with a number                                                                                                                                         |
|                    |                                                                                                                                                                        |
|                    | -   follow a consistent format                                                                                                                                         |
+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Mis-formatted data | Work with functions from base R like `as.numeric()` or from the `tidyverse` packages like `stringr` to clean the data that appear in a different format than you want. |
+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Missing data       | Identify where in your dataset there are missing variables and/or outliers - this may be more of an iterative process as your explore your data.                       |
+--------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

## In-class coding example

TKTK

## Your data will rarely come in a single table, so you will need to use join functions to merge the data frames {.smaller}

To join two data frames, they need to share a common column with a unique identifier.

State departments of education typically assign a unique ID number to each school district. **Make sure this is available in your data sets.**

Joining data sets on a name (e.g. school or district) can create problems based on:

-   Capitalization (Mcgregor v. McGregor)
-   Abbreviation (St. Paul v. Saint Paul)
-   Mis-spelling (it happens!)

## Using `left_join()` to merge data sets will help preserve your data {.smaller}

-   Once you have dataframes that share a common ID column, start with your most reliable set of data (typically student count data like ADM or enrollment) and use `left_join()` to attach additional data to that table.
-   This approach will preserve your original data, keeping the number of rows (e.g. districts or schools) consistent as you use `left_join()` to add data by adding more columns.
-   When a record in the "left" dataframe does not have a match in the "right" dataframe, `left_join()` will impute a value of `NA` for all such instances.

![Source: R for Data Science](https://d33wubrfki0l68.cloudfront.net/3abea0b730526c3f053a3838953c35a0ccbe8980/7f29b/diagrams/join-inner.png){fig-align="center"}

## Coding example: How to use left_join()

-   **Example 1:** The common ID columns have the same variable names (sch_id)
-   **Example 2:** The common ID columns have different variable names. The sch_clean dataframe's variable is sch_id, while the sch_el data frame's variable name is school_id. The column names can be different, but the values within the cells must be the same so we can join them.

## As you merge dataframes, be sure to use the `anti_join()` function to examine missing data {.smaller}

Using the `anti_join()` function from the dplyr package in R returns all rows in one data frame that do not have matching values in another data frame. Using `anti_join()` allows you to explore the incongruities in your data.

![](https://bookdown.org/sulgi/r4ds/diagrams/join-anti.png){fig-align="center"}

## Coding example: How to use the `anti_join()` function

TKTK 



